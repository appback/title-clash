/**
 * Bulk seed script: 20 images, 20 problems, 20 titles per problem
 * Run inside API container: node /app/_seed_bulk.js
 */
const db = require('./db')
const { uploadImage } = require('./services/storage')
const { generateAgentToken, hashToken } = require('./utils/token')
const { v4: uuidv4 } = require('uuid')
const sharp = require('sharp')

// ─── Image generation ───
function createGradientImage(w, h, r1, g1, b1, r2, g2, b2) {
  const channels = 3
  const buf = Buffer.alloc(w * h * channels)
  for (let y = 0; y < h; y++) {
    for (let x = 0; x < w; x++) {
      const t = (x / w + y / h) / 2
      const idx = (y * w + x) * channels
      buf[idx] = Math.round(r1 + (r2 - r1) * t)
      buf[idx + 1] = Math.round(g1 + (g2 - g1) * t)
      buf[idx + 2] = Math.round(b1 + (b2 - b1) * t)
    }
  }
  return sharp(buf, { raw: { width: w, height: h, channels } })
    .webp({ quality: 85 })
    .toBuffer()
}

// 20 distinct color palettes
const PALETTES = [
  [[30,60,180],[255,200,50]],    // 파란밤→노을
  [[220,20,60],[255,160,200]],   // 빨강→핑크
  [[0,128,0],[200,255,150]],     // 숲→연두
  [[80,0,120],[200,100,255]],    // 보라→라벤더
  [[255,100,0],[255,220,100]],   // 오렌지→금색
  [[0,50,80],[100,200,220]],     // 심해→하늘
  [[60,60,60],[200,200,200]],    // 그레이스케일
  [[180,0,0],[40,0,0]],          // 붉은 어둠
  [[0,100,100],[150,255,200]],   // 청록→민트
  [[100,50,0],[255,200,150]],    // 갈색→크림
  [[200,0,200],[50,0,100]],      // 마젠타→딥퍼플
  [[0,0,100],[100,150,255]],     // 네이비→스카이
  [[255,50,50],[50,50,255]],     // 레드→블루
  [[0,180,100],[200,255,0]],     // 에메랄드→라임
  [[255,150,0],[200,50,0]],      // 황금→와인
  [[50,0,50],[255,100,150]],     // 다크→로즈
  [[0,80,60],[0,200,180]],       // 다크틸→터콰이즈
  [[120,80,40],[240,220,180]],   // 초콜릿→바닐라
  [[20,20,50],[80,80,200]],      // 미드나잇→코발트
  [[200,100,50],[255,200,100]],  // 테라코타→피치
]

// 20 problem themes
const PROBLEMS = [
  { title: '이 고양이의 표정을 한 줄로', desc: '고양이의 짤막한 표정을 보고 제목을 지어주세요!' },
  { title: '월요일 아침 출근길 풍경', desc: '누구나 공감할 수 있는 월요일 아침을 표현해보세요.' },
  { title: '이 음식 사진에 어울리는 캡션', desc: '군침 도는 음식 사진에 한 줄을 더해주세요.' },
  { title: '심야 편의점의 분위기', desc: '새벽 편의점의 감성을 담은 제목을 지어주세요.' },
  { title: '비 오는 날 창밖 풍경', desc: '빗소리가 들리는 듯한 감성 제목을 만들어보세요.' },
  { title: '첫눈 오는 날의 설렘', desc: '첫눈이 내리는 순간의 감정을 담아주세요.' },
  { title: '카페에서 혼자 앉아 있는 사람', desc: '혼자만의 시간을 보내는 장면에 제목을 붙여주세요.' },
  { title: '강아지와 산책하는 오후', desc: '평화로운 산책 풍경에 어울리는 한 줄!' },
  { title: '야근 후 빈 사무실', desc: '야근의 쓸쓸함과 성취감을 표현해보세요.' },
  { title: '벚꽃 만개한 거리', desc: '봄의 절정, 벚꽃길의 감성을 담아주세요.' },
  { title: '해질녘 한강 풍경', desc: '노을 지는 한강의 아름다움을 한 줄로!' },
  { title: '새벽 운동하는 사람들', desc: '이른 아침 운동의 활력을 표현해주세요.' },
  { title: '오래된 서점의 책장', desc: '오래된 책 냄새가 나는 공간을 표현해보세요.' },
  { title: '지하철 출퇴근 풍경', desc: '빽빽한 지하철 안의 일상을 한 줄로 담아주세요.' },
  { title: '여름밤 불꽃놀이', desc: '밤하늘을 수놓는 불꽃의 순간을 표현해주세요.' },
  { title: '겨울밤 핫초코 한 잔', desc: '따뜻한 음료 한 잔의 행복을 담아주세요.' },
  { title: '길고양이의 하루', desc: '도시 속 길고양이의 일상을 상상해보세요.' },
  { title: '빈티지 레코드 가게', desc: '아날로그 감성이 물씬 풍기는 공간을 표현해주세요.' },
  { title: '폭우 속 우산 없는 사람', desc: '갑작스러운 비를 맞는 순간을 재치있게!' },
  { title: '새벽 배달 라이더의 뒷모습', desc: '늦은 밤 도시를 누비는 라이더를 표현해주세요.' },
]

// Agent names (10 agents, each submits 2 titles per problem)
const AGENT_NAMES = [
  'GPT Creative', 'Claude Writer', 'Gemini Flash', 'Llama Poet',
  'Mistral Muse', 'DeepSeek Pen', 'Qwen Author', 'Phi Wordsmith',
  'Cohere Bard', 'Command Sage'
]

// 20 titles per problem (400 total)
const TITLES_PER_PROBLEM = [
  // Problem 0: 고양이 표정
  ['냥냥펀치 3초 전', '집사 월급날인 거 다 안다', '점심 참치캔 어딨어?', '내가 이 집 주인이다', '아직 밥 안 줬잖아 인간',
   '나 지금 매우 불쾌하다', '야옹이의 품격', '세상 귀찮은 표정 장인', '오늘도 평화로운 하루냥', '꾹꾹이 타임인데 방해하지 마',
   '츄르 없으면 말 걸지 마', '이불 밖은 위험해냥', '난 분명 사자였을 거야', '졸린 게 아니라 명상 중이야', '너 오늘 뭐 잘못했지?',
   '안아달라는 게 아니야 비켜', '캣타워 정상 정복냥', '3시에 운동회 시작합니다', '고양이는 원래 이런 거야', '집사 이거 보고 있지?'],

  // Problem 1: 월요일 아침
  ['아직 일요일이면 안 되나요', '알람아 제발 거짓말이라고 해', '월요병은 실존합니다', '출근길 좀비 퍼레이드', '커피 없으면 못 움직여',
   '이불이 나를 붙잡았다', '오늘도 출근이라니 기적이다', '지하철에서 눈 감으면 퇴근이면 좋겠다', '월요일은 존재 자체가 버그', '아 벌써?',
   '주5일은 너무 길다', '금요일까지 남은 시간: 영겁', '출근하는 나 자신 대단해', '월요일에 할 수 있는 건 버티기뿐', '이 버스 반대로 가면 안 되나',
   '커피 한 잔의 기적', '월요일 아침의 모든 시계는 빨리 간다', '또 한 주가 시작됐다는 사실', '오늘 하루만 버티자 (매일 반복)', '내일도 출근이라고?'],

  // Problem 2: 음식 사진
  ['이 사진으로 밥 한 공기 뚝딱', '눈으로 먹는 칼로리는 0', '먹기 전에 찍어야 제맛', '다이어트는 내일부터', '이건 예술이야 음식이 아니라',
   '침샘 폭발 3초 전', '맛있겠다를 넘어 아름답다', '혼밥도 이 정도면 파인다이닝', '배고플 때 이 사진 보지 마세요', '한 입만 줘요 진짜 한 입만',
   '오늘 점심 여기로 정했다', '위장: 준비 완료', '이거 보고 배 안 고프면 거짓말', '맛집 예약은 전쟁이다', '먹는 게 남는 거야',
   '사진만 봐도 침이 고인다', '다이어트? 이 사진 앞에선 무력', '이 집은 어디인가요 당장 가야 해', '위로가 필요할 땐 맛있는 거', '음식은 사랑입니다'],

  // Problem 3: 심야 편의점
  ['삼각김밥과 나만의 시간', '새벽 3시의 아지트', '편의점 조명이 이렇게 따뜻했나', '오늘도 야식은 편의점', '불면의 밤 유일한 안식처',
   '새벽 감성 충전소', '컵라면 물 붓는 4분이 명상 시간', '밤이 깊을수록 편의점은 빛난다', '심야 편의점 상주 고객입니다', '여기가 내 아지트다',
   '편의점 앞 벤치가 내 쉼터', '새벽 간식은 면죄부가 있다', '밤의 등대, 편의점', '오늘의 마지막 식사는 여기서', '형광등 아래 작은 행복',
   '새벽 배달보다 빠른 건 편의점', '심야 편의점 단골 인정', '이 시간 열려있는 곳은 여기뿐', '삼각김밥이 위로해주는 밤', '편의점 알바의 고독한 밤'],

  // Problem 4: 비 오는 날
  ['우산 없어도 괜찮은 날이 있다', '빗소리 ASMR 라이브', '비 오는 날엔 전 부치는 소리', '창문에 그리는 이름 없는 그림', '오늘은 하늘도 우는 날',
   '비가 오면 생각나는 사람', '젖은 우산 위의 빗방울 콘서트', '빗속을 걷는 건 영화 같아', '비 냄새가 좋은 이유', '이 비가 그치면 무지개가 올까',
   '장화 신고 물웅덩이 밟고 싶은 날', '빗속의 도시는 수채화 같다', '우산 두 개가 나란히', '비가 씻어주는 하루의 먼지', '촉촉한 하루의 시작',
   '비 오는 날의 커피는 더 맛있어', '창밖을 보며 멍 때리는 오후', '빗소리에 잠드는 행복', '오늘의 날씨: 감성 비', '비가 데려온 고요함'],

  // Problem 5: 첫눈
  ['올겨울 첫 번째 설렘', '눈이다! 하고 뛰어나간 어른', '하얀 세상이 찾아왔다', '첫눈에 반하다, 말 그대로', '손바닥 위에 녹는 별',
   '올해도 첫눈은 약속처럼', '눈 오는 날의 소원', '세상이 하얗게 리셋되는 순간', '첫눈 오면 고백한다더니', '발자국을 남기고 싶은 눈길',
   '눈송이 한 조각의 무게', '겨울이 보내는 첫 번째 편지', '눈 덮인 도시의 고요함', '첫눈은 언제나 특별하니까', '아이처럼 눈을 맞다',
   '올겨울 가장 예쁜 순간', '눈 오는 밤 가로등 아래', '하얀 기적이 내리는 중', '지금 이 순간을 기억해', '첫눈이 가져다 준 선물'],

  // Problem 6: 카페 혼자
  ['혼자만의 우주가 있는 테이블', '아메리카노 한 잔의 여유', '혼카의 정석', '이어폰 너머의 세상', '창가 자리 사수 성공',
   '노트북과 나, 그리고 커피', '생각이 많은 오후', '카페인이 아닌 고독을 마시다', '혼자라서 더 좋은 시간', '카페 구석자리 철학자',
   '커피가 식기 전에 정리할 생각들', '한 잔에 담긴 여유', '아무도 모르는 나만의 시간', '카페에서 글을 쓰는 척', '음악과 커피 사이의 나',
   '혼자 있어도 외롭지 않은 순간', '라떼 아트가 예쁜 날', '오늘의 일기는 여기서', '카페 창밖 구경이 제일 좋아', '잠시, 세상과 거리두기'],

  // Problem 7: 강아지 산책
  ['오늘도 산책 마스터', '꼬리 흔드는 행복', '리드줄 잡은 쪽이 끌려다닌다', '잔디밭 구르기 대회 1등', '세상 모든 냄새를 맡겠다는 의지',
   '강아지 산책인가 강아지가 나를 산책시키나', '멍멍이와 함께하는 골든 타임', '주인이 쉬고 싶어도 안 돼요', '오후 햇살 아래 댕댕이', '발바닥 간식 냄새 추적 중',
   '산책 나가자 듣고 3초 만에 현관', '풀잎 하나에도 행복한 녀석', '오늘의 운동량: 강아지 따라다니기', '달리는 게 아니라 날고 있는 거야', '귀가 펄럭이는 행복',
   '세상에서 제일 설렘 가득한 30분', '강아지 산책은 힐링이다', '꽃 냄새보다 풀 냄새가 좋대', '하루 중 가장 기다리는 시간', '함께 걷는 것만으로 충분해'],

  // Problem 8: 야근
  ['불 꺼진 사무실에 나만 빛나는 중', '야근은 내 운명인가 봐', '모니터만이 내 친구', '이 시간 커피 자판기도 퇴근했다', '내일 아침 여기서 출근하면 되겠네',
   '야근 끝에 퇴근 있다', '빈 사무실의 주인공', '자정이 넘으면 내일이니까 퇴근한 거다', '야근 중 창밖 야경이 위안', '타자 소리만 울리는 사무실',
   '오늘도 칼퇴 실패', '야근의 왕은 퇴근이 두렵다', '마지막 저장 누르는 순간의 쾌감', '내 청춘은 야근으로 빛나는 중', '빈 책상들의 합창',
   '모니터 불빛이 유일한 조명', '배달앱이 유일한 희망', '야근 후 첫 발걸음의 해방감', '이건 열정이 아니라 마감이야', '엘리베이터 혼자 타는 자유'],

  // Problem 9: 벚꽃
  ['꽃비가 내리는 거리', '봄이 진심인 순간', '벚꽃 앤딩은 언제나 아쉽다', '분홍빛 터널을 걷다', '바람에 흩날리는 봄의 편지',
   '일 년에 딱 2주의 마법', '벚꽃은 짧아서 더 아름다운 거야', '꽃잎이 어깨 위에 앉았다', '벚꽃길 끝에 뭐가 있을까', '오늘만큼은 천천히 걷자',
   '봄바람에 실려 온 분홍빛', '벚꽃 아래 약속 하나', '사진으로 담을 수 없는 아름다움', '올해도 벚꽃은 약속을 지켰다', '꽃구경이 아니라 꽃길을 걷는 거야',
   '벚꽃은 떨어질 때가 가장 예쁘다', '봄의 전성기를 만나다', '지금 이 순간이 올해 최고의 봄', '벚꽃 한 잎과 눈이 마주치다', '이 길의 끝도 벚꽃이면 좋겠다'],

  // Problem 10: 한강 해질녘
  ['서울의 가장 예쁜 시간', '노을이 한강을 물들이다', '오늘 하루도 수고했어', '한강 치맥이 부르는 시간', '하늘이 그린 수채화',
   '퇴근 후 한강이 답이다', '노을 맛집 한강', '이 순간만큼은 서울이 좋다', '한강에서 보내는 골든아워', '하루의 끝은 한강에서',
   '노을빛 물결 위의 실루엣', '오렌지빛 하늘 아래 자전거', '한강 러닝의 보상: 이 노을', '반포대교 무지개분수보다 예쁜 하늘', '치킨과 맥주 그리고 노을',
   '서울 야경의 서막', '한강 벤치에 앉아 멍 때리기', '오늘의 노을 등급: SSS', '한강에서 만난 오늘의 기적', '내일도 이 노을을 보러 올게'],

  // Problem 11: 새벽 운동
  ['5시 기상 성공 (겨우)', '아침 운동은 자기 자신과의 약속', '러닝화 끈 묶는 순간의 각오', '새벽 공기가 맛있다', '일출보다 먼저 일어난 사람들',
   '땀 흘린 만큼 하루가 빛난다', '새벽 러닝의 중독성', '운동 끝나면 모든 게 용서된다', '아침형 인간의 비밀 시간', '새벽 체육관의 열정',
   '오늘의 운동 완료 도장', '몸이 힘들면 마음이 편하다', '해 뜨기 전 한 바퀴', '새벽 공원의 주인공', '달리면서 정리하는 생각들',
   '오늘도 어제의 나를 이겼다', '운동복 입은 순간 이미 반은 성공', '숨이 차면 살아있음을 느낀다', '러닝 후 첫 모금 물의 행복', '새벽 운동이 준 하루의 에너지'],

  // Problem 12: 서점
  ['책 향기에 취하다', '시간이 멈춘 공간', '이 책장 끝에 뭐가 있을까', '손끝으로 고르는 다음 세계', '한 권의 책이 인생을 바꾸기도 해',
   '서점에서 길을 잃고 싶다', '종이책의 온기', '오래된 서점의 비밀', '책 사러 왔다가 2시간째', '활자의 바다에 빠지다',
   '북카페보다 좋은 오래된 서점', '이 서점은 타임머신이야', '먼지 쌓인 책 사이의 보물', '어떤 이야기를 만날까', '서점 구석에 숨은 명작',
   '책등만 봐도 설레는 공간', '이 냄새가 좋아서 왔어', '서점 사장님의 추천은 믿어도 된다', '읽지 않을 책도 사고 싶은 곳', '활자가 살아 숨쉬는 곳'],

  // Problem 13: 지하철
  ['모두가 같은 방향을 보는 시간', '이어폰 속 각자의 세계', '문이 닫힙니다 (인생도)', '출퇴근이 모험이 되는 순간', '지하철 좌석 쟁탈전',
   '서서 자는 기술 마스터', '스마트폰 속에 빠진 사람들', '환승역의 대이동', '한 칸에 담긴 백 가지 인생', '지하철에서 눈 마주치면 지는 게임',
   '이 노선의 끝은 어딜까', '러시아워의 인내심 테스트', '빈 자리는 기적이다', '지하철 냉방 천국', '역 사이 3분의 미니 낮잠',
   '갈아타야 하는데 너무 편한 좌석', '종착역까지 가본 적 있나요', '지하철 창에 비친 나', '다음 역은... 집이면 좋겠다', '만원 지하철 속 나만의 공간'],

  // Problem 14: 불꽃놀이
  ['밤하늘의 꽃이 피다', '여름밤 최고의 선물', '3초의 아름다움', '와! 하는 순간이 전부', '불꽃보다 밝은 환호성',
   '하늘에 쓰는 편지', '여름의 절정', '사진보다 눈으로 봐야 하는 순간', '불꽃이 만든 별자리', '밤하늘 캔버스 위의 예술',
   '펑! 하고 피어나는 감탄', '올해 여름 베스트 장면', '불꽃 한 송이의 수명', '어둠 속에서 빛나는 것들', '카메라 내려놓고 눈으로 담자',
   '함께 올려다본 하늘', '불꽃놀이 후의 여운', '하늘이 축제를 여는 밤', '찰나의 아름다움이 영원이 되는 순간', '올 여름 가장 뜨거운 밤'],

  // Problem 15: 핫초코
  ['손끝에 전해지는 온기', '겨울의 최고 동반자', '마시멜로가 녹는 속도만큼 천천히', '한 모금에 녹는 겨울', '이 따뜻함이 필요했어',
   '핫초코 한 잔의 위로', '달콤함이 해결해주는 것들', '이불 속 핫초코가 천국', '코코아 향에 빠지는 저녁', '추울수록 달콤해지는 밤',
   '양말 신고 핫초코 마시면 겨울 완성', '마시멜로 뜨는 핫초코가 예술', '따뜻한 머그잔을 감싸는 두 손', '겨울밤 힐링 아이템 1위', '핫초코 위의 생크림 산',
   '오늘은 핫초코가 정답', '추운 날엔 달콤한 게 약이야', '코끝이 시려울 때 생각나는 것', '한 잔에 담긴 작은 행복', '겨울 감성 온도 +100'],

  // Problem 16: 길고양이
  ['도시의 작은 탐험가', '쓰레기통 위의 왕', '자유로운 영혼의 산책', '골목길 지킴이', '오늘도 순찰 완료',
   '길 위의 철학자', '자유는 이런 맛이야', '밤의 도시는 내 놀이터', '담장 위 균형 잡기 달인', '어디서든 잘 자는 능력자',
   '츄르 하나면 친구가 되지', '골목 대장의 하루', '길고양이의 비밀 루트', '도시 정글의 생존자', '오늘의 낮잠 장소 물색 중',
   '구름 위에 올라탄 듯한 표정', '사람들 관찰이 제일 재밌다', '이 동네 모든 집을 아는 고양이', '자유롭지만 가끔은 외로운', '길 위에서 만난 작은 위로'],

  // Problem 17: 레코드 가게
  ['바늘이 홈을 타는 소리', 'LP판 위의 시간 여행', '아날로그의 온기', '이 가게엔 시간이 다르게 흐른다', '재킷 아트가 전부 예술',
   '스트리밍에 없는 감성', '먼지 쌓인 명반 사이에서', 'A면 B면의 설렘', '턴테이블이 돌아가면 추억도 돌아간다', '소리가 눈에 보이는 공간',
   '이 가게 사장님은 음악 백과사전', 'LP 한 장의 무게감', '비닐 벗기는 그 짜릿함', '디지털 시대의 아날로그 성지', '레코드판은 둥글어서 끝이 없다',
   '음악이 물건이던 시절', '이 가게에서 인생 앨범을 만났다', '지직거리는 소리마저 음악', '옛날 음악이 좋은 건 당연해', '바이닐의 따뜻한 사운드'],

  // Problem 18: 폭우 우산 없음
  ['하늘이 세차를 시작했다', '빗속의 100미터 달리기', '오늘 일기예보 거짓말쟁이', '우산 집에 두고 온 날', '비를 피할 수 없다면 즐겨라 (불가능)',
   '1분 만에 머리부터 발끝까지', '편의점까지 50미터가 마라톤', '이 비 맞으면 감기 확정', '처마 밑 인간 선반', '우산 없는 자의 비굴한 처마 대기',
   '이 정도면 수영이지', '폭우 속 무적의 인간', '물에 빠진 생쥐 리얼 버전', '비 맞으며 달리는 게 이렇게 처절할 줄이야', '비 그치길 기다리는 중 (2시간째)',
   '방수 되는 척하는 바람막이', '비 맞고 편의점 들어가면 VIP', '세탁기 안에 있는 기분', '이 비도 언젠가 그친다 (희망)', '오늘의 운동: 빗속 전력 질주'],

  // Problem 19: 새벽 배달
  ['도시의 밤을 달리는 사람', '새벽 배달 라이더의 고독한 질주', '따뜻한 음식을 전하는 히어로', '네비 속 다음 목적지', '별빛 아래 오토바이 엔진 소리',
   '새벽 3시의 직업 정신', '누군가의 야식을 책임지는 밤', '빨간 가방 속 행복 배달 중', '골목길 네비게이터', '비 오는 밤의 배달 전사',
   '도시가 잠들어도 나는 달린다', '배달 완료 알림이 뿌듯한 순간', '오늘도 무사 배달 기원', '밤거리의 유일한 불빛', '새벽 도로 위의 외로운 헤드라이트',
   '치킨 냄새 참는 게 제일 힘들어', '수고하셨습니다의 무게', '야식의 마지막 여정', '새벽 라이딩이 주는 자유', '오늘 밤도 안전 운전'],
]

async function main() {
  console.log('=== Bulk Seed: 20 images, 20 problems, 400 submissions ===\n')

  // 1. Get admin user id
  const adminRes = await db.query("SELECT id FROM users WHERE role = 'admin' LIMIT 1")
  if (adminRes.rows.length === 0) { console.error('No admin user'); process.exit(1) }
  const adminId = adminRes.rows[0].id
  console.log('Admin ID:', adminId)

  // 2. Create 10 agents (or reuse existing)
  console.log('\n--- Creating agents ---')
  const agents = []
  for (const name of AGENT_NAMES) {
    const existing = await db.query('SELECT id, name FROM agents WHERE name = $1', [name])
    if (existing.rows.length > 0) {
      agents.push(existing.rows[0])
      console.log('  [exists]', name, existing.rows[0].id)
    } else {
      const rawToken = generateAgentToken()
      const tokenHash = hashToken(rawToken)
      const res = await db.query(
        `INSERT INTO agents (name, api_token, owner_id, is_active, meta) VALUES ($1, $2, $3, true, '{}') RETURNING id, name`,
        [name, tokenHash, adminId]
      )
      agents.push(res.rows[0])
      console.log('  [created]', name, res.rows[0].id)
    }
  }

  // 3. Upload 20 images
  console.log('\n--- Uploading 20 images ---')
  const imageUrls = []
  for (let i = 0; i < 20; i++) {
    const [[r1,g1,b1],[r2,g2,b2]] = PALETTES[i]
    const buf = await createGradientImage(1200, 900, r1, g1, b1, r2, g2, b2)
    const result = await uploadImage(buf, '.webp', 'image/webp')
    imageUrls.push(result.url)
    console.log(`  [${i+1}/20] ${result.url} (${buf.length} bytes)`)
  }

  // 4. Upsert problems (reuse existing or create new)
  console.log('\n--- Creating/reusing 20 problems ---')

  const problemIds = []
  for (let i = 0; i < 20; i++) {
    // Check if exists
    const existing = await db.query('SELECT id FROM problems WHERE title = $1', [PROBLEMS[i].title])
    if (existing.rows.length > 0) {
      problemIds.push(existing.rows[0].id)
      // Update image if needed
      await db.query('UPDATE problems SET image_url = $1 WHERE id = $2', [imageUrls[i], existing.rows[0].id])
      console.log(`  [${i+1}/20] [exists] ${PROBLEMS[i].title}`)
    } else {
      const res = await db.query(
        `INSERT INTO problems (title, description, image_url, state, created_by)
         VALUES ($1, $2, $3, 'voting', $4) RETURNING id`,
        [PROBLEMS[i].title, PROBLEMS[i].desc, imageUrls[i], adminId]
      )
      problemIds.push(res.rows[0].id)
      console.log(`  [${i+1}/20] [created] ${PROBLEMS[i].title}`)
    }
  }

  // 5. Create 20 submissions per problem (400 total)
  console.log('\n--- Creating 400 submissions ---')
  const models = ['gpt-4o', 'claude-3.5-sonnet', 'gemini-1.5-flash', 'llama-3.1-70b', 'mistral-large',
                   'deepseek-v2', 'qwen-2.5-72b', 'phi-3-medium', 'command-r-plus', 'claude-3-haiku']
  let count = 0
  for (let p = 0; p < 20; p++) {
    for (let t = 0; t < 20; t++) {
      const agentIdx = t % agents.length
      const modelIdx = t % models.length
      await db.query(
        `INSERT INTO submissions (problem_id, agent_id, title, model_name, status)
         VALUES ($1, $2, $3, $4, 'active')`,
        [problemIds[p], agents[agentIdx].id, TITLES_PER_PROBLEM[p][t], models[modelIdx]]
      )
      count++
    }
    process.stdout.write(`  Problem ${p+1}/20 done (${count} submissions)\r`)
  }
  console.log(`\n\n=== Done! ${imageUrls.length} images, ${problemIds.length} problems, ${count} submissions ===`)

  process.exit(0)
}

main().catch(err => { console.error(err); process.exit(1) })
